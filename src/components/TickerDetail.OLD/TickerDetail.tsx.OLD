import React, { useEffect, useMemo, useState } from "react";

import { Box, Grid } from "@mui/material";
import NetworkProgressIndicator from '@components/NetworkProgressIndicator';

import Center from "@layoutKit/Center";

import LazyRender from "@components/LazyRender";
import SectorsPieChart from "@components/SectorsPieChart";
import TickerVectorTable from "@components/TickerVectorQueryTable";

import useTickerDetail from "@hooks/useTickerDetail";

import type { RustServiceETFAggregateDetail } from "@utils/callRustService";
import { fetchETFAggregateDetailByTickerId } from "@utils/callRustService";
import customLogger from "@utils/customLogger";
import formatSymbolWithExchange from "@utils/string/formatSymbolWithExchange";

import TickerContainer from "../TickerContainer";
import TickerDetailBucketManager from "./TickerDetail.BucketManager";
import ETFHolderList from "./TickerDetail.ETFHolderList";
import ETFHoldingList from "./TickerDetail.ETFHoldingList";
import FinancialChartsGrid from "./TickerDetail.FinancialChartsGrid";
import TickerDetailHeader from "./TickerDetail.Header";
import HistoricalPriceChart from "./TickerDetail.HistoricalPriceChart";
import PCAScatterPlot from "./TickerDetail.PCAScatterPlot";

export type TickerDetailProps = React.HTMLAttributes<HTMLDivElement> & {
  tickerId: number;
  onIntersectionStateChange?: (isIntersecting: boolean) => void;
  onLoad?: () => void;
  preventLoadingSpinner?: boolean;
};

export default function TickerDetail({
  tickerId,
  onIntersectionStateChange,
  onLoad,
  preventLoadingSpinner = false,
  ...rest
}: TickerDetailProps) {
  const { isLoadingTickerDetail, tickerDetail } = useTickerDetail(
    tickerId,
    onLoad,
  );
  const [etfAggregateDetail, setETFAggregateDetail] = useState<
    RustServiceETFAggregateDetail | undefined
  >(undefined);

  useEffect(() => {
    if (tickerDetail?.is_etf) {
      fetchETFAggregateDetailByTickerId(tickerDetail.ticker_id).then(
        setETFAggregateDetail,
      );
    }
  }, [tickerDetail]);

  useEffect(() => {
    if (etfAggregateDetail) {
      customLogger.debug({ etfAggregateDetail });
    }
  }, [etfAggregateDetail]);

  const formattedSymbolWithExchange = useMemo(
    () => tickerDetail && formatSymbolWithExchange(tickerDetail),
    [tickerDetail],
  );

  if (isLoadingTickerDetail && !preventLoadingSpinner) {
    return (
      <Center>
        <NetworkProgressIndicator />
      </Center>
    );
  }

  if (!formattedSymbolWithExchange || !tickerDetail) {
    return null;
  }

  return (
    <TickerContainer
      style={{ marginBottom: 12 }}
      tickerId={tickerDetail.ticker_id}
      onIntersectionStateChange={onIntersectionStateChange}
      {...rest}
    >
      {/* Header Section */}
      <Grid container spacing={2}>
        <Grid item xs={12} md={6}>
          <TickerDetailHeader
            tickerDetail={tickerDetail}
            etfAggregateDetail={etfAggregateDetail}
            formattedSymbolWithExchange={formattedSymbolWithExchange}
          />
        </Grid>
      </Grid>

      {/* Historical Price Chart - Full Width */}
      <Grid container spacing={2} sx={{ marginTop: 2 }}>
        <Grid item xs={12}>
          <HistoricalPriceChart
            tickerSymbol={tickerDetail.symbol}
            formattedSymbolWithExchange={formattedSymbolWithExchange}
          />
        </Grid>
      </Grid>

      {/* Bucket Manager */}
      <Box sx={{ textAlign: "center", margin: "20px 0" }}>
        <TickerDetailBucketManager tickerDetail={tickerDetail} />
      </Box>

      {/* Grid layout for side-by-side chart */}
      <Box
        sx={{
          display: "grid",
          gridTemplateColumns: "repeat(2, 1fr)", // Two equal-width columns
          gridAutoRows: "minmax(100px, auto)", // Adjust rows dynamically
          gap: 2, // Gap between the boxes
        }}
      >
        <Box>
          <LazyRender>
            <PCAScatterPlot tickerDetail={tickerDetail} />
          </LazyRender>
        </Box>

        {etfAggregateDetail?.major_sector_distribution && (
          <Box>
            <SectorsPieChart
              majorSectorDistribution={
                etfAggregateDetail?.major_sector_distribution
              }
            />
          </Box>
        )}
      </Box>

      {/* Grid layout for the table and financial charts */}
      <Box
        sx={{
          display: "grid",
          gridTemplateColumns: "repeat(2, 1fr)", // Two equal-width columns
          gridTemplateRows: "masonry", // Masonry for rows
          gap: 2, // Gap between columns and rows
          marginTop: 2,
        }}
      >
        <Box sx={{ border: "1px yellow solid" }}>
          <TickerVectorTable queryMode={"ticker-detail"} query={tickerDetail} />
        </Box>

        <Box sx={{ border: "1px yellow solid" }}>
          <FinancialChartsGrid tickerDetail={tickerDetail} />
        </Box>

        {tickerDetail?.is_etf && (
          <Box sx={{ border: "1px yellow solid" }}>
            <ETFHoldingList etfTickerDetail={tickerDetail} />
          </Box>
        )}

        {tickerDetail?.is_held_in_etf && (
          <Box sx={{ border: "1px yellow solid" }}>
            <ETFHolderList tickerDetail={tickerDetail} />
          </Box>
        )}
      </Box>
    </TickerContainer>
  );
}
